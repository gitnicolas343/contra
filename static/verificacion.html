<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ContractRed – Iniciar sesión</title>
  
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  
      :root {
        --primary: #6a0dad;
        --primary-light: #8a2be2;
        --primary-dark: #4a0072;
        --primary-soft: #ece0ff;
        --text-main: #111827;
        --text-secondary: #4b5563;
        --nav-text: #333333;
        --bg-start: #f0f4ff;
        --bg-end: #e0e8ff;
        --white: #ffffff;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
        --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
        --error: #e11d48;
      }
  
      * { box-sizing: border-box; }
  
      body {
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
        background-attachment: fixed;
        color: var(--text-main);
        min-height: 100vh;
      }
  
      header {
        padding: 16px 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 3px solid transparent;
        border-image: linear-gradient(90deg, var(--primary), var(--primary-light)) 1;
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-md);
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      header img { height: 90px; }
  
      nav {
        background: linear-gradient(135deg, var(--white), #fafbff);
        padding: 10px 18px;
        border-radius: 16px;
        display: flex;
        gap: 8px;
        border: 1px solid rgba(106, 13, 173, 0.15);
        box-shadow: var(--shadow-sm);
      }
      nav a {
        font-size: 15px;
        color: var(--nav-text);
        text-decoration: none;
        font-weight: 600;
        padding: 8px 14px;
        border-radius: 12px;
        transition: all 0.25s ease;
      }
      nav a:hover {
        background: var(--primary-soft);
        color: var(--primary);
      }
  
      main {
        padding: 44px 18px 60px;
        display: flex;
        justify-content: center;
      }
  
      .card {
        width: 100%;
        max-width: 560px;
        background: var(--white);
        border-radius: 24px;
        padding: 28px 26px;
        border: 1px solid rgba(148,163,184,0.4);
        box-shadow: 0 12px 40px rgba(15,23,42,0.15);
      }
  
      .title {
        font-size: 26px;
        font-weight: 800;
        margin: 0 0 8px 0;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
  
      .subtitle {
        margin: 0 0 18px 0;
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.6;
      }
  
      .section-title {
        font-weight: 800;
        margin: 18px 0 10px;
        font-size: 14px;
        color: var(--text-main);
      }
  
      /* =========================
         BOTÓN GOOGLE (estándar)
         ========================= */
      .btn-social{
        width: 100%;
        height: 52px;
        border: none;
        border-radius: 999px;
        cursor: pointer;
  
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
  
        color: #fff;
        font-weight: 700;
        font-size: 15px;
  
        background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
        box-shadow: 0 8px 22px rgba(106,13,173,0.35);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
  
      .btn-social:hover{
        transform: translateY(-2px);
        box-shadow: 0 14px 32px rgba(106,13,173,0.45);
      }
  
      .btn-social:active{
        transform: translateY(0);
      }
  
      /* ICONO EXACTO como tu captura: círculo blanco + anillo oscuro */
      .btn-social .social-icon{
        width: 34px;
        height: 34px;
        border-radius: 999px;
  
        display: inline-flex;
        align-items: center;
        justify-content: center;
  
        background: #ffffff;
        border: 3px solid rgba(0,0,0,0.70);
        box-shadow: 0 6px 16px rgba(0,0,0,0.28);
  
        filter: none;
      }
  
      .btn-social .social-icon svg{
        width: 18px;
        height: 18px;
        display: block;
      }
  
      .divider {
        margin: 18px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-secondary);
        font-size: 12px;
      }
      .divider::before, .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: rgba(148,163,184,0.5);
      }
  
      .form-row { margin-bottom: 12px; }
      label { display: block; font-weight: 700; font-size: 13px; margin-bottom: 6px; }
  
      .input {
        width: 100%;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(148,163,184,0.6);
        outline: none;
        font-size: 14px;
      }
      .input:focus {
        border-color: rgba(106,13,173,0.35);
        box-shadow: 0 0 0 4px rgba(106,13,173,0.10);
      }
  
      .btn-primary {
        width: 100%;
        padding: 12px 14px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-weight: 800;
        color: #fff;
        background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
        box-shadow: 0 14px 30px rgba(106,13,173,0.28);
        transition: transform 0.15s ease;
      }
      .btn-primary:hover { transform: translateY(-1px); }
      .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  
      .hint {
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-secondary);
      }
  
      .error {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(225,29,72,0.10);
        border: 1px solid rgba(225,29,72,0.25);
        color: #9f1239;
        font-weight: 600;
        display: none;
      }
  
      /* =========================
         MODALES
         ========================= */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px;
        z-index: 2000;
      }
  
      .modal-card {
        width: 100%;
        max-width: 920px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.25);
        padding: 18px 18px;
        border: 1px solid rgba(148,163,184,0.4);
        max-height: 86vh;
        overflow: auto;
      }
  
      .modal-title { margin: 4px 0 6px; font-size: 18px; font-weight: 900; }
      .modal-text  { margin: 0 0 12px; color: var(--text-secondary); font-size: 14px; }
  
      .modal-detalle-title { font-weight: 900; margin: 10px 0 8px; }
      .modal-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .modal-table th, .modal-table td {
        border-bottom: 1px solid rgba(148,163,184,0.45);
        padding: 10px 8px;
        text-align: left;
        vertical-align: top;
      }
      .modal-table th { background: rgba(106,13,173,0.06); font-weight: 900; }
      .modal-note { margin-top: 10px; font-size: 12px; color: var(--text-secondary); }
  
      .modal-actions {
        margin-top: 14px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
  
      .loading-card {
        width: 100%;
        max-width: 420px;
        background: #fff;
        border-radius: 20px;
        padding: 18px 18px;
        border: 1px solid rgba(148,163,184,0.4);
        box-shadow: 0 20px 50px rgba(0,0,0,0.25);
        text-align: center;
      }
  
      .spinner {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 5px solid rgba(106,13,173,0.18);
        border-top-color: rgba(106,13,173,0.9);
        margin: 6px auto 10px;
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
  
      .loading-title { font-weight: 900; margin: 8px 0 6px; }
      .loading-text { font-size: 13px; color: var(--text-secondary); margin: 0; }
  
      @media (max-width: 900px) {
        header { padding: 14px 18px; flex-direction: column; align-items: flex-start; gap: 10px; }
        nav { width: 100%; justify-content: center; flex-wrap: wrap; }
        header img { height: 72px; }
      }

      /* ====== FIX: estilos que tu HTML usa pero tu CSS no tenía ====== */
    html { scroll-behavior: smooth; }
        
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(18px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeInUp 0.7s cubic-bezier(0.4,0,0.2,1) forwards; }
    
    .section { width: 100%; }
    .section-narrow { max-width: 880px; margin: 0 auto; }
    
    .hero-card {
      background: radial-gradient(circle at 0% 0%, #f9f5ff 0, #ffffff 55%);
      padding: 30px 28px 32px;
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }
    .hero-card::before{
      content:'';
      position:absolute; left:0; right:0; top:0; height:3px;
      background: linear-gradient(90deg, var(--primary), var(--primary-light), var(--primary));
      opacity: 0.85;
    }
    .hero-card::after{
      content:'';
      position:absolute; bottom:-40%; right:-30%;
      width:55%; height:55%;
      background: radial-gradient(circle, rgba(106,13,173,0.10) 0%, transparent 70%);
      pointer-events:none;
    }
    .hero-inner { position: relative; z-index: 1; }
    
    .step-badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; font-weight:600;
      padding:4px 10px; border-radius:999px;
      background: rgba(236,224,255,0.9);
      color: var(--primary-dark);
      margin-bottom: 10px;
      border: 1px solid rgba(148,163,184,0.7);
    }
    .step-dot{ width:7px; height:7px; border-radius:999px; background: var(--primary); }
    
    .hero-title{
      font-size:26px; font-weight:800; margin: 0 0 6px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .hero-text{ font-size:15px; color: var(--text-secondary); margin: 0 0 12px; }
    .hero-subtext{ font-size:13px; color:#6b7280; margin: 0 0 18px; }
    
    .form-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px 18px;
      margin-top:6px;
    }
    .form-row{ display:flex; flex-direction:column; }
    .form-row label{
      font-size:14px; font-weight:500; color:#374151;
      margin-bottom:6px;
    }
    
    .input-field, select.input-field{
      width:100%;
      padding:11px 13px;
      border-radius:14px;
      border:1px solid #cbd5e1;
      font-size:15px;
      background:#f9fafb;
      transition: all 0.2s ease;
    }
    .input-field::placeholder{ color:#9ca3af; }
    .input-field:focus{
      outline:none;
      border-color: var(--primary-light);
      background:#ffffff;
      box-shadow: 0 0 0 1px rgba(129,140,248,0.4);
    }
    
    .full-row{ grid-column: 1 / -1; }
    
    .checkbox-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      font-size:13px;
      color:#4b5563;
    }
    .checkbox-row input[type="checkbox"]{ margin-top:3px; }
    
    .error-text{
      color: var(--error);
      font-size:12px;
      margin-top:4px;
      min-height:14px;
    }
    .info-note{
      margin-top:12px;
      font-size:12px;
      color:#6b7280;
    }
    
    @media (max-width: 900px){
      .section-narrow{ max-width:100%; }
      .hero-card{ padding: 24px 20px 26px; border-radius: 20px; }
      .form-grid{ grid-template-columns: minmax(0,1fr); }
    }
    @media (max-width: 600px){
      .hero-title{ font-size:22px; }
    }

    </style>
  </head>
  

  <body>
    <header>
      <a href="/static/index.html">
        <img src="assets/logo.png" alt="Logo ContractRed" />
      </a>

      <nav>
        <a href="/static/login.html">Iniciar sesión</a>
        <a href="/static/promociones.html">Promociones</a>
        <a href="/static/ayuda.html">Ayuda</a>
      </nav>
    </header>

    <main>
      <section class="section">
        <div class="section-narrow">
          <div class="hero-card fade-in">
            <div class="hero-inner">
              <div class="step-badge">
                <span class="step-dot"></span>
                Paso 2 de 2 · Completa tu información
              </div>

              <h1 class="hero-title">Completa los datos de tu empresa</h1>

              <p class="hero-text">
                Ya verificamos tu correo. Ahora dinos quién eres y a nombre de qué empresa te postularás a las
                oportunidades de contratación estatal.
              </p>

              <p class="hero-subtext">
                Estos datos nos ayudan a ajustar mejor las alertas y filtros a tu realidad empresarial.
              </p>

              <form id="verificacion-form" onsubmit="return handleVerificacion(event)">
                <div class="form-grid">
                  <div class="form-row full-row">
                    <label for="nombre">Nombre completo</label>
                    <input id="nombre" class="input-field" type="text" placeholder="Nombre y apellidos" />
                    <div class="error-text" id="error-nombre"></div>
                  </div>

                  <div class="form-row">
                    <label for="tipo_documento">Tipo de documento</label>
                    <select id="tipo_documento" class="input-field">
                      <option value="">Selecciona una opción</option>
                      <option value="CC">Cédula de ciudadanía</option>
                      <option value="CE">Cédula de extranjería</option>
                      <option value="NIT">NIT</option>
                      <option value="PAS">Pasaporte</option>
                    </select>
                    <div class="error-text" id="error-tipo-doc"></div>
                  </div>

                  <div class="form-row">
                    <label for="numero_documento">Número de documento</label>
                    <input id="numero_documento" class="input-field" type="text" placeholder="Ej. 1234567890" />
                    <div class="error-text" id="error-num-doc"></div>
                  </div>

                  <div class="form-row">
                    <label for="nit">NIT de la empresa (opcional)</label>
                    <input id="nit" class="input-field" type="text" placeholder="NIT sin dígito de verificación" />
                    <div class="error-text" id="error-nit"></div>
                  </div>

                  <div class="form-row">
                    <label for="empresa">Nombre de la empresa</label>
                    <input id="empresa" class="input-field" type="text" placeholder="Razón social o nombre comercial" />
                    <div class="error-text" id="error-empresa"></div>
                  </div>

                  <div class="form-row full-row">
                    <label for="actividad_comercial">Actividad comercial principal (opcional)</label>
                    <input
                      id="actividad_comercial"
                      class="input-field"
                      type="text"
                      placeholder="Ej. Consultoría, suministros, obra civil, etc."
                    />
                    <div class="error-text" id="error-actividad"></div>
                  </div>

                  <div class="form-row">
                    <label for="departamento">Departamento</label>
                    <select id="departamento" class="input-field">
                      <option value="">Selecciona un departamento</option>
                      <option value="Amazonas">Amazonas</option>
                      <option value="Antioquia">Antioquia</option>
                      <option value="Arauca">Arauca</option>
                      <option value="Atlántico">Atlántico</option>
                      <option value="Bolívar">Bolívar</option>
                      <option value="Boyacá">Boyacá</option>
                      <option value="Caldas">Caldas</option>
                      <option value="Caquetá">Caquetá</option>
                      <option value="Casanare">Casanare</option>
                      <option value="Cauca">Cauca</option>
                      <option value="Cesar">Cesar</option>
                      <option value="Chocó">Chocó</option>
                      <option value="Córdoba">Córdoba</option>
                      <option value="Cundinamarca">Cundinamarca</option>
                      <option value="Guainía">Guainía</option>
                      <option value="Guaviare">Guaviare</option>
                      <option value="Huila">Huila</option>
                      <option value="La Guajira">La Guajira</option>
                      <option value="Magdalena">Magdalena</option>
                      <option value="Meta">Meta</option>
                      <option value="Nariño">Nariño</option>
                      <option value="Norte de Santander">Norte de Santander</option>
                      <option value="Putumayo">Putumayo</option>
                      <option value="Quindío">Quindío</option>
                      <option value="Risaralda">Risaralda</option>
                      <option value="San Andrés y Providencia">San Andrés y Providencia</option>
                      <option value="Santander">Santander</option>
                      <option value="Sucre">Sucre</option>
                      <option value="Tolima">Tolima</option>
                      <option value="Valle del Cauca">Valle del Cauca</option>
                      <option value="Vaupés">Vaupés</option>
                      <option value="Vichada">Vichada</option>
                    </select>
                    <div class="error-text" id="error-departamento"></div>
                  </div>

                  <div class="form-row">
                    <label for="ciudad">Ciudad principal</label>
                    <input id="ciudad" class="input-field" type="text" placeholder="Ej. Bogotá D.C., Medellín, Cali" />
                    <div class="error-text" id="error-ciudad"></div>
                  </div>

                  <div class="form-row full-row">
                    <label for="telefono">Teléfono de contacto</label>
                    <input id="telefono" class="input-field" type="tel" placeholder="Celular o teléfono fijo" />
                    <div class="error-text" id="error-telefono"></div>
                  </div>

                  <div class="form-row full-row">
                    <label class="checkbox-row">
                      <input type="checkbox" id="acepta_politica" />
                      <span>
                        Confirmo que soy representante autorizado de la empresa o tengo permiso para postularla a procesos
                        de contratación estatal.
                      </span>
                    </label>
                    <div class="error-text" id="error-politica"></div>
                  </div>
                </div>

                <button type="submit" class="btn-primary">Guardar datos y continuar</button>

                <p class="info-note">
                  Usaremos esta información para personalizar tus alertas y ayudarte a encontrar los procesos de
                  contratación que mejor se ajustan a tu perfil.
                </p>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const API_BASE = window.location.origin;
      const usuarioId = localStorage.getItem("usuario_id");

      if (!usuarioId) {
        alert(
          "No encontramos tu sesión de registro.\n" +
            "Por favor, vuelve a crear tu cuenta desde la página de inscripción."
        );
        window.location.href = "/static/inscripcion.html";
      }

      function setLoading(show) {
        const modalLoading = document.getElementById("modal-loading");
        if (modalLoading) modalLoading.style.display = show ? "flex" : "none";
      }

      function nextFrame() {
        return new Promise((resolve) =>
          requestAnimationFrame(() => requestAnimationFrame(resolve))
        );
      }

      async function handleVerificacion(event) {
        event.preventDefault();

        const errorIds = [
          "error-nombre",
          "error-tipo-doc",
          "error-num-doc",
          "error-nit",
          "error-empresa",
          "error-actividad",
          "error-departamento",
          "error-ciudad",
          "error-telefono",
          "error-politica",
        ];

        errorIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.textContent = "";
        });

        const nombre = document.getElementById("nombre").value.trim();
        const tipoDocumento = document.getElementById("tipo_documento").value;
        const numeroDocumento = document.getElementById("numero_documento").value.trim();
        const nit = document.getElementById("nit").value.trim();
        const empresa = document.getElementById("empresa").value.trim();
        const actividadComercial = document.getElementById("actividad_comercial").value.trim();
        const departamento = document.getElementById("departamento").value;
        const ciudad = document.getElementById("ciudad").value.trim();
        const telefono = document.getElementById("telefono").value.trim();
        const aceptaPolitica = document.getElementById("acepta_politica").checked;

        let ok = true;

        if (!nombre) {
          document.getElementById("error-nombre").textContent = "Ingresa tu nombre completo.";
          ok = false;
        }

        if (!tipoDocumento) {
          document.getElementById("error-tipo-doc").textContent = "Selecciona el tipo de documento.";
          ok = false;
        }

        if (!numeroDocumento) {
          document.getElementById("error-num-doc").textContent = "Ingresa tu número de documento.";
          ok = false;
        }

        if (!empresa) {
          document.getElementById("error-empresa").textContent = "Ingresa el nombre de la empresa.";
          ok = false;
        }

        if (!telefono) {
          document.getElementById("error-telefono").textContent = "Ingresa un teléfono de contacto.";
          ok = false;
        }

        if (!aceptaPolitica) {
          document.getElementById("error-politica").textContent =
            "Debes confirmar que estás autorizado para registrar esta empresa.";
          ok = false;
        }

        if (!ok) return false;

        let ubicacion = "";
        if (ciudad && departamento) ubicacion = `${ciudad}, ${departamento}`;
        else if (ciudad) ubicacion = ciudad;
        else if (departamento) ubicacion = departamento;

        const payload = {
          usuario_id: usuarioId,
          nombre_completo: nombre,
          tipo_documento: tipoDocumento,
          numero_documento: numeroDocumento,
          nit: nit || null,
          empresa: empresa,
          telefono: telefono,
          actividad_comercial: actividadComercial || null,
          ubicacion_geografica: ubicacion || null,
        };

        try {
          // 1) Guardar datos
          const res = await fetch(API_BASE + "/completar_registro", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const json = await res.json().catch(() => null);

          if (!res.ok) {
            alert(
              "No pudimos guardar tus datos.\n\n" +
                (json && json.detail ? json.detail : "Revisa tu conexión o intenta más tarde.")
            );
            return false;
          }

          // 2) Consultar listas negras con loader
          let mensajeFinal = "";
          let tituloFinal = "";
          let resumenListas = null;

          setLoading(true);
          await nextFrame();

          try {
            const respListas = await fetch(
              API_BASE + "/listas_negras/resumen?usuario_id=" + encodeURIComponent(usuarioId),
              { method: "GET", headers: { Accept: "application/json" } }
            );

            if (respListas.ok) {
              resumenListas = await respListas.json();

              if (resumenListas.en_lista_negra) {
                tituloFinal = "Atención: encontramos sanciones registradas";
                mensajeFinal =
                  resumenListas.resumen ||
                  "Se encontraron sanciones asociadas a este registro. Revisa el detalle antes de continuar.";
              } else {
                tituloFinal = "Verificación completada";
                mensajeFinal =
                  resumenListas.resumen ||
                  "No se encontraron sanciones vigentes asociadas a este registro.";
              }
            } else {
              tituloFinal = "Verificación parcial";
              mensajeFinal =
                "Tus datos se guardaron correctamente, pero no pudimos verificar las listas negras en este momento.";
            }
          } catch (e) {
            console.error("Error llamando a /listas_negras/resumen:", e);
            tituloFinal = "Verificación parcial";
            mensajeFinal =
              "Tus datos se guardaron correctamente, pero ocurrió un error de conexión al verificar las listas negras.";
          } finally {
            setLoading(false);
          }

          // 3) Mostrar modal con resultado
          const modal = document.getElementById("modal-listas");
          const tituloModal = document.getElementById("modal-titulo");
          const mensajeModal = document.getElementById("modal-mensaje");
          const detalleModal = document.getElementById("modal-detalle");
          const btnContinuar = document.getElementById("modal-continuar");

          if (!modal || !tituloModal || !mensajeModal || !detalleModal || !btnContinuar) {
            alert(mensajeFinal || "Tus datos se guardaron correctamente.");
            window.location.href = "/static/index.html";
            return false;
          }

          tituloModal.textContent = tituloFinal || "Resultado de la verificación";
          mensajeModal.textContent = mensajeFinal || "";

          let tablaHtml = "";

          if (resumenListas && Array.isArray(resumenListas.sanciones) && resumenListas.sanciones.length > 0) {
            const filasHtml = resumenListas.sanciones
              .slice(0, 10)
              .map((sancion, idx) => {
                const fuente = sancion.fuente || "-";
                const tipo = sancion.tipo_detalle || sancion.tipo_registro || "-";
                const nombreSan = sancion.nombre_sancionado || "-";
                const identificador = sancion.identificador || "-";
                const estado = sancion.estado || "-";
                const fecha = sancion.fecha_evento || "-";

                let valorTexto = "-";
                if (sancion.valor_multa !== null && sancion.valor_multa !== undefined) {
                  try {
                    valorTexto = Number(sancion.valor_multa).toLocaleString("es-CO", {
                      style: "currency",
                      currency: "COP",
                      maximumFractionDigits: 0,
                    });
                  } catch (_) {
                    valorTexto = String(sancion.valor_multa);
                  }
                }

                let linkHtml = "-";
                if (sancion.url_detalle) {
                  linkHtml = `<a href="${sancion.url_detalle}" target="_blank" rel="noopener noreferrer">Ver proceso</a>`;
                }

                return `
                  <tr>
                    <td>${idx + 1}</td>
                    <td>${fuente}</td>
                    <td>${tipo}</td>
                    <td>${nombreSan}</td>
                    <td>${identificador}</td>
                    <td>${valorTexto}</td>
                    <td>${fecha}</td>
                    <td>${estado}</td>
                    <td>${linkHtml}</td>
                  </tr>
                `;
              })
              .join("");

            tablaHtml = `
              <div class="modal-detalle-title">Detalle de sanciones encontradas</div>
              <table class="modal-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Fuente</th>
                    <th>Tipo</th>
                    <th>Sancionado / Proveedor</th>
                    <th>Identificador</th>
                    <th>Valor</th>
                    <th>Fecha evento</th>
                    <th>Estado</th>
                    <th>Enlace</th>
                  </tr>
                </thead>
                <tbody>
                  ${filasHtml}
                </tbody>
              </table>
              <p class="modal-note">
                Mostrando hasta 10 sanciones. Para más detalle revisa las fuentes oficiales (Procuraduría, SECOP I y SECOP II).
              </p>
            `;
          }

          detalleModal.innerHTML = tablaHtml;
          modal.style.display = "flex";

          const estaEnListaNegra = !!(resumenListas && resumenListas.en_lista_negra);

          // si está en listas negras, NO puede continuar: solo ayuda
          btnContinuar.textContent = estaEnListaNegra ? "Ir a ayuda" : "Continuar";

          btnContinuar.onclick = async () => {
            btnContinuar.disabled = true;
            modal.style.display = "none";

            setLoading(true);
            await nextFrame();

            window.location.href = estaEnListaNegra ? "/static/ayuda.html" : "/static/lobby.html";
          };

          return false;
        } catch (err) {
          console.error("Error en completar_registro:", err);
          alert(
            "Ocurrió un error inesperado guardando tus datos.\n\n" +
              (err && err.message ? err.message : String(err))
          );
          return false;
        }
      }
    </script>

    <!-- MODAL LISTAS NEGRAS -->
    <div id="modal-listas" class="modal-backdrop" style="display: none">
      <div class="modal-card">
        <h2 id="modal-titulo" class="modal-title"></h2>
        <p id="modal-mensaje" class="modal-text"></p>

        <div id="modal-detalle" class="modal-detalle"></div>

        <div class="modal-actions">
          <button id="modal-continuar" class="btn-primary">Entendido y continuar</button>
        </div>
      </div>
    </div>

    <!-- MODAL CARGANDO -->
    <div id="modal-loading" class="modal-backdrop" style="display: none">
      <div class="loading-card" role="dialog" aria-modal="true" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <div class="loading-title">Cargando...</div>
        <div class="loading-text">Estamos preparando tu panel. Por favor espera.</div>
      </div>
    </div>
  </body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verificando tu cuenta de Google ‚Äì ContractRed</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root {
      --primary: #6a0dad;
      --primary-light: #8a2be2;
      --primary-dark: #4a0072;
      --bg-start: #f0f4ff;
      --bg-end: #e0e8ff;
      --text-main: #111827;
      --text-secondary: #4b5563;
      --white: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
    }

    .card {
      background: var(--white);
      border-radius: 24px;
      padding: 28px 26px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 12px 40px rgba(15,23,42,0.15);
      border: 1px solid rgba(148,163,184,0.4);
    }

    .title {
      font-size: 22px;
      font-weight: 800;
      margin: 0 0 8px 0;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .status {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .status-strong {
      font-weight: 600;
    }

    .hint {
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .btn {
      margin-top: 16px;
      display: inline-block;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="title">Verificando tu cuenta de Google‚Ä¶</h1>
    <p class="subtitle">
      Estamos conectando tu cuenta de Google con ContractRed y registrando tus datos b√°sicos.
    </p>
    <p class="status">
      <span class="status-strong" id="status-main">Procesando autenticaci√≥n‚Ä¶</span>
    </p>
    <p class="status" id="status-detail"></p>
    <p class="hint" id="hint">
      No cierres esta ventana. Este proceso solo toma unos segundos.
    </p>
    <button
      class="btn"
      id="btn-volver"
      style="display:none;"
      onclick="window.location.href='inscripcion.html'"
    >
      Volver a inscripci√≥n
    </button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ndsyaetglshulaqadvzl.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kc3lhZXRnbHNodWxhcWFkdnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0Mzk0NzEsImV4cCI6MjA4MDAxNTQ3MX0.Z2URIwgvLfpV6fdOv_fgIS-X-es2Zvlwq7QnB1Oo0Js";

    // URL de tu backend FastAPI
    const API_BASE = window.location.origin;




    // No dependemos del auto-detect; lo haremos a mano
    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      {
        auth: { detectSessionInUrl: false },
      }
    );

    const statusMain   = document.getElementById("status-main");
    const statusDetail = document.getElementById("status-detail");
    const hintEl       = document.getElementById("hint");
    const btnVolver    = document.getElementById("btn-volver");

    (async () => {
      try {
        // 0) Parsear el hash de la URL: #access_token=...&refresh_token=...
        const hash = window.location.hash.startsWith("#")
          ? window.location.hash.substring(1)
          : window.location.hash;
        const params = new URLSearchParams(hash);

        const accessToken  = params.get("access_token");
        const refreshToken = params.get("refresh_token"); // por si quieres usarlo luego

        console.log("URL actual:", window.location.href);
        console.log("Fragmento parseado:", Object.fromEntries(params.entries()));

        if (!accessToken) {
          statusMain.textContent   = "No se encontr√≥ el token de acceso.";
          statusDetail.textContent = "Vuelve a iniciar sesi√≥n con Google desde la p√°gina de inscripci√≥n.";
          hintEl.textContent       = "Te redirigiremos a inscripci√≥n.";
          btnVolver.style.display  = "inline-block";

          setTimeout(() => {
            window.location.href = "/static/inscripcion.html";
          }, 4500);
          return;
        }

        statusMain.textContent   = "Verificando tu inicio de sesi√≥n con Google‚Ä¶";
        statusDetail.textContent = "Obteniendo tus datos desde Supabase.";

        // 1) Pedir el usuario usando expl√≠citamente el access_token
        const { data, error } = await supabaseClient.auth.getUser(accessToken);
        console.log("Resultado getUser(accessToken):", { data, error });

        if (error || !data?.user) {
          console.error("Error en getUser OAuth:", error);
          statusMain.textContent   = "No pudimos confirmar tu inicio de sesi√≥n.";
          statusDetail.textContent = "El enlace puede haber expirado o no es v√°lido. Vuelve a iniciar sesi√≥n con Google.";
          hintEl.textContent       = "Te redirigiremos a la p√°gina de inscripci√≥n.";
          btnVolver.style.display  = "inline-block";

          setTimeout(() => {
            window.location.href = "/static/inscripcion.html";
          }, 4500);
          return;
        }

        const user     = data.user;
        const email    = user.email;
        const provider = user.app_metadata?.provider || "google";
        const auth_id  = user.id;

        console.log("Datos del usuario de Google:", { email, provider, auth_id });

        statusMain.textContent   = "Cuenta de Google verificada.";
        statusDetail.textContent = "Registrando tu usuario en ContractRed‚Ä¶";

        // 2) Registrar/actualizar en tu tabla 'usuarios' v√≠a backend
        const res = await fetch(API_BASE + "/registrar_oauth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, provider, auth_id }),
        });

        const json = await res.json().catch(() => ({}));
        console.log("Respuesta /registrar_oauth (oauth):", json);

        // üü£ CASO ESPECIAL: el correo ya estaba registrado CON CONTRASE√ëA
        if (json && json.ya_existia && json.motivo === "registrado_con_contrasena") {
          statusMain.textContent   = "Este correo ya est√° registrado con contrase√±a.";
          statusDetail.textContent = "Para proteger tu cuenta, inicia sesi√≥n usando tu correo y contrase√±a.";
          hintEl.textContent       = "Te llevaremos a la pantalla de inicio de sesi√≥n.";

          btnVolver.style.display = "inline-block";

          setTimeout(() => {
            window.location.href = "/static/login.html";
          }, 4000);
          return;
        }

        // Otros errores gen√©ricos
        if (!res.ok || !json.ok) {
          const detalle = (json && json.error) ? json.error : (res.status + " " + res.statusText);
          
          statusMain.textContent   = "Hubo un problema registrando tu cuenta.";
          statusDetail.textContent = "Detalle: " + detalle;
          statusDetail.textContent = "Intenta nuevamente iniciar sesi√≥n con Google o usa tu correo.";
          hintEl.textContent       = "Te redirigiremos a inscripci√≥n.";
          btnVolver.style.display  = "inline-block";

          setTimeout(() => {
            window.location.href = "/static/inscripcion.html";
          }, 25000);
          return;
        }

        // 3) Guardar usuario_id si vino en la respuesta
        let fila = null;
        if (json.data && Array.isArray(json.data.data) && json.data.data[0]) {
          fila = json.data.data[0];
        } else if (Array.isArray(json.data) && json.data[0]) {
          fila = json.data[0];
        }

        if (fila && fila.id) {
          localStorage.setItem("usuario_id", fila.id);
        }

        // 4) Flujo seg√∫n si ya exist√≠a o no
        if (json.ya_existia) {
          statusMain.textContent   = "Este correo ya estaba registrado en ContractRed.";
          statusDetail.textContent = "Te llevaremos a la pantalla de inicio de sesi√≥n.";
          hintEl.textContent       = "Si no recuerdas tu contrase√±a, podr√°s recuperarla desde el login.";

          setTimeout(() => {
            window.location.href = "/static/login.html";
          }, 3500);
        } else {
          statusMain.textContent   = "Tu cuenta se ha creado correctamente.";
          statusDetail.textContent = "Ahora completa tus datos personales para terminar el registro.";
          hintEl.textContent       = "No cierres esta ventana.";

          setTimeout(() => {
            window.location.href = "/static/verificacion.html";
          }, 3500);
        }
      } catch (e) {
        console.error("Error inesperado en verificacion_oauth:", e);
        statusMain.textContent   = "Error inesperado durante la verificaci√≥n.";
        statusDetail.textContent = "Intenta iniciar sesi√≥n nuevamente con Google.";
        hintEl.textContent       = "Te redirigiremos a inscripci√≥n.";
        btnVolver.style.display  = "inline-block";

        setTimeout(() => {
          window.location.href = "/static/inscripcion.html";
        }, 4500);
      }
    })();
  </script>
</body>
</html>
